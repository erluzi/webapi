<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no,email=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>blob对象</title>
    <style>
        section{
            margin-bottom: .4rem;
        }

        form{
            border: 1px solid gray;
            padding: 10px 5px;
        }
        label{
            cursor: pointer;
        }
        label:hover{
            color: orange;
        }
        input[type='file']{
            display: none;
        }

        .box-drop{
            position: relative;
            width: 200px;
            height: 200px;
            border: 1px solid gray;
        }
        #abort{
            position: absolute;
            right: 0;
            bottom: 0;
        }
        img{
            max-width: 100%;
            height: auto;
        }
        button{
            padding: .5em 1em;
            border: none;
            color: #fff;
        }
        .btn-danger{
            background-color: orange;
        }
    </style>
</head>
<body>
<section>
    <a href="https://github.com/ruanyf/jstutorial/blob/gh-pages/htmlapi/file.md" target="_blank">启发&来源</a>
</section>
<section>
    <form id="form-single" action="/single" method="post" enctype="multipart/form-data">
        <label for="file">单文件上传</label>
        <input id="file" type="file" name="avatar">
        <input type="submit" value="提交">
    </form>
    <form id="form-multiple" action="/multiple" method="post" enctype="multipart/form-data">
        <label for="photos">多文件上传</label>
        <input id="photos" type="file" name="photos" multiple>
        <input type="submit" value="提交">
    </form>
</section>
<section>
    <div class="box-drop">
        请把文件拖入此框
        <button class="btn-danger" id="abort">abort</button>
    </div>
</section>
<section class="sec-pics">

</section>
<script>
    function init(){
        var $ = document.querySelector.bind(document);
        var file = $('#file');
        var photos = $('#photos');
        var boxDrop = $('.box-drop');
        var secPics = $('.sec-pics');
        var abort = $('#abort');

        //单文件
        file.addEventListener('change', function () {
            var blob = this.files[0];
            if(blob.type === 'text/plain'){
                //读取内容
                var reader = new FileReader();
                reader.onload = function () {
                    var text = reader.result;
                    append(text)
                };
                reader.readAsText(blob);
            }else{
                append('type error, please upload text')
            }
        });

        //拖拽上传
        boxDrop.addEventListener('dragover', function (e) {
            e.preventDefault()
        });
        boxDrop.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var files = e.dataTransfer.files;
            uploadFiles(files);
            //debugger;
            [].forEach.call(files, function (item) {
                //图片回显
                if(/image\//g.test(item.type)){
                    var readerImg = new FileReader();
                    var img = new Image();
                    readerImg.onload = function (e) {
                        img.src = e.target.result;
                        secPics.appendChild(img);
                    };
                    readerImg.readAsDataURL(item);

                }
                //上传到服务器(任何类型的文件)
                var reader = new FileReader();
                reader.onload = function () {
                    //todo nodejs获取流数据-保存到对应文件
                    //upload(reader.result);
                    console.log(item.name+' 读取完成')
                };
                reader.onprogress = function (e) {
                    if(e.lengthComputable){
                        var percentLoaded = parseFloat(e.loaded / e.total * 100).toFixed(2);
                        console.log(item.name+' 读取进度: '+percentLoaded+'%')
                    }
                };
                reader.onabort = function () {
                    console.log(item.name+' 读取中断')
                };

                abort.addEventListener('click', function () {
                    reader.abort()
                });

                reader.readAsBinaryString(item);
            });
        });

        generateAnchorDownload();
    }

    //生成可下载链接
    function generateAnchorDownload(){
        var blob = new Blob(["Hello! World!"]);

        var a = document.createElement("a");
        a.href = window.URL.createObjectURL(blob);
        a.download = "hello-world.txt";
        a.textContent = "Download Hello World!";

        document.body.appendChild(a);
    }

    function append(ele, msg){
        if(arguments.length==1){
            msg = ele;
            ele = 'p';
        }
        var element = document.createElement(ele);
        element.textContent = msg;
        document.body.appendChild(element)
    }

    function upload(blobOrFile) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);
        xhr.onload = function() {
            console.log('onload')
        };
        xhr.send(blobOrFile);
        //xhr.sendAsBinary(blobOrFile);
    }

    /**
     * 拖拽上传,支持多文件
     * @param files
     */
    function uploadFiles(files){
        var xhr = new XMLHttpRequest();
        xhr.open("post", "/multiple", true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

        var fd = new FormData();

        for(var i=0,l=files.length; i<l; i++){
            fd.append('photos', files[i])
        }

        xhr.send(fd);
    }
    window.onload = init;

</script>
</body>
</html>