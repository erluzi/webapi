<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no,email=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>blob对象</title>
    <link rel="stylesheet" href="css/blob.css">
</head>
<body>
<section>
    <a href="https://github.com/ruanyf/jstutorial/blob/gh-pages/htmlapi/file.md" target="_blank">启发&来源</a>
</section>
<section>
    <form id="form-single" action="/single" method="post" enctype="multipart/form-data">
        <label for="file">单文件上传</label>
        <input id="file" type="file" name="avatar">
        <input type="submit" value="提交">
    </form>
    <form id="form-multiple" action="/multiple" method="post" enctype="multipart/form-data">
        <label for="photos">多文件上传</label>
        <input id="photos" type="file" name="photos" multiple>
        <input type="submit" value="提交">
    </form>
</section>
<section>
    <div class="box-drop">
        请把文件拖入此框
        <button class="btn-danger" id="abort">abort</button>
    </div>
</section>
<section class="sec-pics">

</section>
<script>
    function init(){
        var $ = document.querySelector.bind(document);
        var file = $('#file');
        var photos = $('#photos');
        var boxDrop = $('.box-drop');
        var secPics = $('.sec-pics');
        var abort = $('#abort');

        //单文件
        file.addEventListener('change', function () {
            var blob = this.files[0];
            if(blob.type === 'text/plain'){
                //读取内容
                var reader = new FileReader();
                reader.onload = function () {
                    var text = reader.result;
                    append(text)
                };
                reader.readAsText(blob);
            }else{
                append('type error, please upload text')
            }
        });

        //拖拽上传
        boxDrop.addEventListener('dragover', function (e) {
            e.preventDefault()
        });
        boxDrop.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var files = e.dataTransfer.files;
            uploadFiles(files);
            //debugger;
            [].forEach.call(files, function (item) {
                //图片回显
                if(/image\//g.test(item.type)){
                    var readerImg = new FileReader();
                    var img = new Image();
                    readerImg.onload = function (e) {
                        img.src = e.target.result;
                        secPics.appendChild(img);
                    };
                    readerImg.readAsDataURL(item);

                }
                //上传到服务器(任何类型的文件)
                var reader = new FileReader();
                reader.onload = function () {
                    //todo nodejs获取流数据-保存到对应文件
                    //upload(reader.result);
                    console.log(item.name+' 读取完成')
                };
                reader.onprogress = function (e) {
                    if(e.lengthComputable){
                        var percentLoaded = parseFloat(e.loaded / e.total * 100).toFixed(2);
                        console.log(item.name+' 读取进度: '+percentLoaded+'%')
                    }
                };
                reader.onabort = function () {
                    console.log(item.name+' 读取中断')
                };

                abort.addEventListener('click', function () {
                    reader.abort()
                });

                reader.readAsBinaryString(item);
            });
        });

        generateAnchorDownload();
    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
    }

    //生成可下载链接
    function generateAnchorDownload(){
        var b64 = 'data:image/png;base64,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'
        // var b64Data = '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'

        // var blob = new Blob(["Hello! World!"]);
        // var blob = b64toBlob(b64Data, 'image/png');
        var a = document.createElement("a");
        // a.href = window.URL.createObjectURL(blob);
        a.href = b64;
        // a.download = "hello-world.txt";
        a.download = "qr.png";
        a.textContent = "Download Hello World!";
        document.body.appendChild(a);
    }

    function append(ele, msg){
        if(arguments.length==1){
            msg = ele;
            ele = 'p';
        }
        var element = document.createElement(ele);
        element.textContent = msg;
        document.body.appendChild(element)
    }

    function upload(blobOrFile) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);
        xhr.onload = function() {
            console.log('onload')
        };
        xhr.send(blobOrFile);
        //xhr.sendAsBinary(blobOrFile);
    }

    /**
     * 拖拽上传,支持多文件
     * @param files
     */
    function uploadFiles(files){
        var xhr = new XMLHttpRequest();
        xhr.open("post", "/multiple", true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

        var fd = new FormData();

        for(var i=0,l=files.length; i<l; i++){
            fd.append('photos', files[i])
        }

        xhr.send(fd);
    }

    window.onload = init;

</script>
</body>
</html>